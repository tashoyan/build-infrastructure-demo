#!/bin/sh

set -o nounset
set -o errexit
set -o pipefail

#Variables generated by build
product_full_name="@{distribution.product.full.name}"
product_short_name="@{distribution.product.short.name}"
permission_mode="@{mode.dir}"
product_config_file="@{product.config.file}"

function show_help() {
  echo "Usage:"
  echo "  $(basename $0) [OPTION]"
  echo ""
  echo "Description:"
  echo "  $(basename $0) is a command to run $product_full_name."
  echo ""
  echo "Options:"
  echo "  -h"
  echo "    Print a usage message briefly summarizing these command-line options, then exit."
  echo ""
  echo "Exit status:"
  echo "  Exits with status 0 if a command executed successfully, greater than 0 if errors occur."
}

main_class="com.github.tashoyan.demo.Main"

# Set default mode mask for all files and directories created by this script
permission_mask="$(expr 777 - $permission_mode)"
umask "$permission_mask"

if echo "$0" | grep -q /
then
    # Started with absolute or relative path
	install_dir="$(cd "$(dirname -- "$0")" ; cd .. ; pwd)"
else
	# Started from PATH
	install_dir="$(cd "$(dirname -- "$(which "$0")")" ; cd .. ; pwd)"
fi

# Load installation parameters
# The environment lib has been generated during installation
source "$install_dir/libexec/lib_env.sh"

# Load environment
source "$install_dir/libexec/lib_log.sh"
source "$install_dir/libexec/lib_java.sh"

log_info "Invoked as: $(cd "$(dirname "$0")" && pwd)/$(basename "$0") ${@:-}"

# Load user-configurable settings
# data_dir is declared in the environment lib
source "$data_dir/conf/$product_config_file"

# Check that script was called with help option, or without option at all
if test $# -gt 0
then
  option="$1"
  shift
  case "$option" in
    -h)
      show_help
      exit 0
    ;;
    *)
      log_error "Invalid option: \"$option\""
      show_help
      exit 1
    ;;
  esac
fi

product_classpath=$(find "$install_dir/lib" -maxdepth 1 -type f -name "*.jar" -printf "%p:")
ext_classpath=$(find "$install_dir/lib/ext" -type f -name "*.jar" -printf "%p:")
classpath="$product_classpath$ext_classpath"

app_properties="\
\"-D$product_short_name\" \
\"-Dinstall.dir=$install_dir\" \
\"-Ddata.dir=$data_dir\" \
\"-Dlog4j.configuration=file:$data_dir/conf/log4j.xml\" \
"

eval nohup $JAVA \
  "$java_properties" \
  "$app_properties" \
  -cp "$classpath" \
  "$main_class" \
  "${@:-}" \
  "2>&1" "</dev/null" "|" "tee" "-a" "\"$(get_log_file)\""
